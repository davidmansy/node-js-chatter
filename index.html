
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://chatbuilder.hackreactor.com/ChatBuilder.js"></script>
  </head>
  <body>
    <script>
      /*
       *  Nice, you found the HTML source code for ChatBuilder! This document kicks everything off when you load it
       *  in your browser, and is a starting point for the whole app. It's pretty incomplete though--you should
       *  make your own version of it that works better!
       *
       *  You can't edit the code here until it's in a file on your hard drive, so copy this whole page of source
       *  code and paste it into a plain text editor like Sublime Text 2 (http://www.sublimetext.com/). Save it as
       *  a `.html` file, and open that file with Google Chrome. You can now edit it however you like, and refresh
       *  the page to see your modifications take effect on how the application runs.
       *
       *  Fair warning: one or more of the steps ahead could require a good amount of research to understand all
       *  the terms and technologies mentioned. Googling words you haven't heard before is a great idea. Just be
       *  careful not to spend too long in 'research mode' without making any forward progress on your real goal of
       *  completing the app!
       *
       *
       *  When you've got this code saved as a local file, uncomment the line of JavaScript code below and open
       *  the new file in Google Chrome. Your next instructions will be waiting for you in the JavaScript console.
       *  If you already know the Chrome JS development tools pretty well, feel free to skip this opening tutorial
       *  by calling the `.start()` function on `Chat.guide` instead of `.intro()`
       */

      //Chat.guide.start();
      delete Chat.display;
      delete Chat.fetch;
      delete Chat.send;


      //MAIN PROGRAM LOGIC
      $(document).ready(function() {

        //Making the button enabled
        $('.send').removeAttr('disabled');

        //Connect to the server
        var server = io.connect('http://ec2-54-200-14-77.us-west-2.compute.amazonaws.com');

        server.on('connect', function(data) {
          $('#status').html("Connected to Chattr");
          nickname = prompt("What is your nickname?");
          server.emit('join', nickname);
        });

        server.on('add chatter', function(nickname) {
          displayChatter(nickname);
        })

        server.on('messages', function(message) {
          display(message);
        });

        //If click on send, send a message to the server with the value of the input tag
        $('.send').on('click', function(event) {
          event.preventDefault();
          var message = $('.draft').val();
          server.emit("messages", message);
          $('.draft').val('');
        });

      });
      //END OF MAIN PROGRAM LOGIC

      //HELPERS FUNCTIONS
      //Display a message
      var listCount = 0;
      function display(str) {
        var ul = $('.messages');
        if (listCount == 10) {
          ul.children('li').first().remove();
          listCount--;
        }
        ul.append('<li>' + str + '</li>');
        listCount++;
      }
      
      //Display a chatter
      function displayChatter(str) {
        var ul = $('.chatters');
        ul.append('<li>' + str + '</li>');
      }

      //OLD      
      function refreshMessages() {
        //Using the function getMessages() enables to have the variable counter not being global, this counter is only related to getting the messages
        var counter = 0;
        
        //Call fetch every 3 sec
        //setInterval calls an anonymous function including a call to fetch with an argument being an anonymous function to display the messages
        setInterval(function() {

          fetch(function (messages) {
            //If first call, load the full list, counter is accessed via a closure
            if (counter == 0) {
              for (var i = 0; i < 10; i++) {
                display(messages[i]);
              }
              counter = 1;            
            } else {
              //Else update each existing list item
              var li = $('.messages').children('li').first();
              for (var i = 0; i < messages.length; i++) {
                li.text(messages[i]);
                li = li.next();
              }
            }
          }); 

        }, 3000);
      }

      //Rewriting fetch function
      function fetch(fn) {

        var arr = [];

        $.ajax('https://api.parse.com/1/classes/chats', {
          contentType: 'application/json',
          dataType: 'json',
          data: {'order': 'updatedAt'},
          success: function(response) {
            //Fill in the array with the messages retrieved from the server
            //The callback function has access to the variable arr via a closure
            $.each(response.results, function(index, message) {
              console.log(message);
              arr.push(message.text);
            });
            //Call the argument function with the messages array as argument
            fn(arr);
          },
          error: function(request, errorType, errorMessage) {
            console.log('Error: ' + errorType + ' with message ' + errorMessage);
          }
        });

      }

      //Rewriting send function
      function send(str) {
        console.log(str);

        $.ajax('https://api.parse.com/1/classes/chats', {
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({'text': str}),
          dataType: 'json',
          success: function(result) {
            console.log(result);
          },
          error: function(request, errorType, errorMessage) {
            console.log('Error: ' + errorType + ' with message ' + errorMessage);
            console.log(str);
          }
        });

      }
      
    </script>


    <h2>Node Borken Chat</h2>


    <input class="draft" type="text"/> <button class="send" disabled>send</button>
    <p id="status"></p>
    <ul class="chatters">
    </ul>

    <p>Messages</p>
    <ul class="messages">
    </ul>

  </body>
</html>